{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediMimes Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'medicines/css/chatbot.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
  </style>
</head>

<body class="bg-light">
  <!-- In your navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="{% url 'dashboard' %}">💊 MediMimes</a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3">Welcome, {{ user.username }}!</span>
        <a class="nav-link" href="{% url 'med_list' %}">Medications</a>
        <a class="nav-link" href="{% url 'logout' %}">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h1 class="text-center mb-4">📊 Dashboard</h1>

    <!-- Summary Cards -->
    <div class="row text-center mb-4">
      <div class="col-md-3 mb-2">
        <div class="card bg-success text-white p-3">Adherence: {{ adherence }}%</div>
      </div>
      <div class="col-md-3 mb-2">
        <div class="card bg-info text-white p-3">Next Dose: {{ next_dose }}</div>
      </div>
      <div class="col-md-3 mb-2">
        <div class="card bg-warning text-white p-3">Streak: {{ streak }} days</div>
      </div>
      <div class="col-md-3 mb-2">
        <div class="card bg-primary text-white p-3">Total: {{ total_doses }}</div>
      </div>
    </div>

    <!-- Today's Doses -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">📋 Today's Doses</h4>
          </div>
          <div class="card-body">
            {% for dose in dose_data %}
            <div class="dose-item d-flex justify-content-between align-items-center border-bottom pb-3 mb-3">
              <div>
                <strong class="h5">{{ dose.pill_name }}</strong>
                <span class="text-muted ms-2">at {{ dose.time }}</span>
                {% if dose.status == 'taken' %}
                <span class="badge bg-success ms-2">✅ Taken</span>
                {% elif dose.status == 'missed' %}
                <span class="badge bg-danger ms-2">❌ Missed</span>
                {% else %}
                <span class="badge bg-warning ms-2">⏰ Pending</span>
                {% endif %}
              </div>
              <div class="btn-group">
                <button class="btn btn-success btn-sm mark-taken-btn" data-dose-id="{{ dose.dose_log_id }}">
                  ✅ Taken
                </button>
                <button class="btn btn-danger btn-sm mark-missed-btn" data-dose-id="{{ dose.dose_log_id }}">
                  ❌ Missed
                </button>
              </div>
            </div>
            {% empty %}
            <p class="text-muted text-center py-3">No doses scheduled for today. 🎉</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">📈 Today's Progress</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="todayChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">📊 Weekly Adherence</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="weeklyChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'components/chatbot.html' %}
  <script src="{% static 'medicines/js/chatbot.js' %}"></script>
  <script>
    // Simple status update
    document.querySelectorAll('.mark-taken-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        updateDoseStatus(this.dataset.doseId, 'taken');
      });
    });

    document.querySelectorAll('.mark-missed-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        updateDoseStatus(this.dataset.doseId, 'missed');
      });
    });

    function updateDoseStatus(doseId, status) {
      fetch("{% url 'toggle_dose_status' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          dose_log_id: doseId,
          status: status
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            location.reload();
          } else {
            alert('Error: ' + (data.message || 'Failed to update'));
          }
        });
    }

    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Parse data from Django
      const doseData = JSON.parse('{{ dose_data_json|escapejs }}');
      const weeklyAdherence = JSON.parse('{{ weekly_adherence_json|escapejs }}');
      const weekDays = JSON.parse('{{ week_days_json|escapejs }}');

      // Today's Progress Chart
      const todayCtx = document.getElementById('todayChart');
      if (todayCtx) {
        const takenCount = doseData.filter(d => d.status === 'taken').length;
        const missedCount = doseData.filter(d => d.status === 'missed').length;
        const pendingCount = doseData.filter(d => d.status === 'pending').length;

        new Chart(todayCtx, {
          type: 'doughnut',
          data: {
            labels: ['Taken (' + takenCount + ')', 'Missed (' + missedCount + ')', 'Pending (' + pendingCount + ')'],
            datasets: [{
              data: [takenCount, missedCount, pendingCount],
              backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      // Weekly Adherence Chart
      const weeklyCtx = document.getElementById('weeklyChart');
      if (weeklyCtx) {
        new Chart(weeklyCtx, {
          type: 'line',
          data: {
            labels: weekDays,
            datasets: [{
              label: 'Adherence %',
              data: weeklyAdherence,
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              borderWidth: 3,
              pointBackgroundColor: '#0d6efd',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function (value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
      }
    });

    // Auto-refresh every 30 seconds
    setTimeout(() => location.reload(), 30000);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>