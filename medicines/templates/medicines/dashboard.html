{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediMimes Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'medicines/css/chatbot.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');

    :root {
      --disney-blue: #1a3e6f;
      --disney-gold: #ffd700;
      --disney-red: #d4002a;
      --disney-purple: #6a0dad;
      --disney-silver: #c0c0c0;
      --magic-sparkle: #b19cd9;
    }

    body {
      background: linear-gradient(135deg, #1a3e6f 0%, #6a0dad 50%, #d4002a 100%);
      min-height: 100vh;
      font-family: 'Quicksand', sans-serif;
      position: relative;
      overflow-x: hidden;
    }

    /* Magical sparkle effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.3) 2px, transparent 2px),
        radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.3) 2px, transparent 2px),
        radial-gradient(circle at 40% 40%, rgba(177, 156, 217, 0.2) 1px, transparent 1px);
      background-size: 100px 100px, 150px 150px, 200px 200px;
      pointer-events: none;
      z-index: -1;
      animation: sparkle 20s linear infinite;
    }

    @keyframes sparkle {
      0% { transform: translateY(0px) rotate(0deg); }
      100% { transform: translateY(-100px) rotate(360deg); }
    }

    .dashboard-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 25px;
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.3),
        0 0 50px rgba(255, 215, 0, 0.2);
      margin-top: 2rem;
      margin-bottom: 2rem;
      border: 3px solid var(--disney-gold);
      position: relative;
      overflow: hidden;
    }

    .dashboard-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, 
        var(--disney-blue), 
        var(--disney-purple), 
        var(--disney-red), 
        var(--disney-gold));
      z-index: 10;
    }

    .navbar-disney {
      background: linear-gradient(135deg, var(--disney-blue) 0%, var(--disney-purple) 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      border-bottom: 3px solid var(--disney-gold);
      font-weight: 600;
    }

    .card-magical {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid;
      border-radius: 20px;
      box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.15),
        0 0 20px rgba(255, 215, 0, 0.1);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      overflow: hidden;
      position: relative;
    }

    .card-magical::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.4), 
        transparent);
      transition: left 0.6s;
    }

    .card-magical:hover::before {
      left: 100%;
    }

    .card-magical:hover {
      box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.2),
        0 0 30px rgba(255, 215, 0, 0.3);
    }

    .summary-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid var(--disney-silver);
      border-radius: 18px;
      padding: 1.5rem;
      text-align: center;
      position: relative;
    }

    .summary-card::after {
      content: '‚ú®';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 1.2rem;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.3) rotate(180deg); }
    }

    .summary-card.adherence {
      border-color: #28a745;
      background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
    }

    .summary-card.next-dose {
      border-color: #17a2b8;
      background: linear-gradient(135deg, #f0f8ff 0%, #ffffff 100%);
    }

    .summary-card.streak {
      border-color: #ffc107;
      background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
    }

    .summary-card.total {
      border-color: #6c757d;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    }

    .summary-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      display: block;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .dose-item {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 18px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 2px solid;
      border-left: 6px solid;
      transition: all 0.3s ease;
      position: relative;
    }

    .dose-item::before {
      position: absolute;
      left: -15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .dose-item:hover::before {
      opacity: 1;
    }

    .dose-item:hover {
      transform: translateX(2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .dose-item.taken {
      border-color: #28a745;
      background: linear-gradient(135deg, #f0fff4 0%, #ffffff 100%);
    }

    .dose-item.missed {
      border-color: #dc3545;
      background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
    }

    .dose-item.pending {
      border-color: #ffc107;
      background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
    }

    .chart-container {
      position: relative;
      height: 280px;
      width: 100%;
      background: white;
      border-radius: 15px;
      padding: 1rem;
      border: 2px solid var(--disney-silver);
    }

    .btn-magical {
      background: linear-gradient(135deg, var(--disney-purple) 0%, var(--disney-blue) 100%);
      border: 2px solid var(--disney-gold);
      color: white;
      border-radius: 25px;
      padding: 0.6rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-magical::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.3), 
        transparent);
      transition: left 0.5s;
    }

    .btn-magical:hover::before {
      left: 100%;
    }

    .btn-magical:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .badge-magical {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      border: 1px solid;
      background: white;
    }

    .card-header-magical {
      background: linear-gradient(135deg, var(--disney-blue) 0%, var(--disney-purple) 100%);
      color: white;
      border: none;
      padding: 1.25rem;
      font-weight: 700;
      position: relative;
    }

    .card-header-magical::after {
      content: 'üéØ';
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.8rem;
      background: linear-gradient(45deg, var(--disney-gold), var(--disney-silver));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    h1, h2, h3, h4, h5, h6 {
      color: var(--disney-blue);
      font-weight: 700;
    }

    .welcome-title {
      background: linear-gradient(45deg, var(--disney-blue), var(--disney-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      display: inline-block;
    }

    .welcome-title::after {
      content: '‚ú®';
      position: absolute;
      right: -40px;
      top: 0;
      animation: spin 3s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px dashed var(--disney-silver);
      border-radius: 20px;
      padding: 3rem;
      text-align: center;
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-disney">
    <div class="container">
      <a class="navbar-brand" href="{% url 'dashboard' %}">
        <i class="fas fa-magic me-2"></i>MediMimes
      </a>
      <div class="navbar-nav ms-auto align-items-center">
        <span class="navbar-text me-4 text-light">
          <i class="fas fa-crown me-2"></i>Welcome, {{ user.username }}!
        </span>
        <a class="nav-link text-light me-3" href="{% url 'med_list' %}">
          <i class="fas fa-scroll me-1"></i>Medications
        </a>
        <a class="nav-link text-light" href="{% url 'logout' %}">
          <i class="fas fa-door-open me-1"></i>Logout
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <div class="dashboard-container p-4 p-lg-5">
      <!-- Header -->
      <div class="text-center mb-5">
        <h1 class="welcome-title display-4 fw-bold mb-3">Medication Dashboard</h1>
        <p class="lead text-muted">Your magical journey to better health! ‚ú®</p>
      </div>

      <!-- Summary Cards -->
      <div class="row g-4 mb-5">
        <div class="col-md-3 col-6">
          <div class="card-magical summary-card adherence">
            <i class="fas fa-chart-line summary-icon text-success"></i>
            <h6 class="text-muted mb-1">Adherence Rate</h6>
            <h3 class="mb-0 text-success fw-bold">{{ adherence }}%</h3>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="card-magical summary-card next-dose">
            <i class="fas fa-clock summary-icon text-primary"></i>
            <h6 class="text-muted mb-1">Next Dose</h6>
            <h5 class="mb-0 text-primary fw-bold">{{ next_dose }}</h5>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="card-magical summary-card streak">
            <i class="fas fa-fire summary-icon text-warning"></i>
            <h6 class="text-muted mb-1">Current Streak</h6>
            <h3 class="mb-0 text-warning fw-bold">{{ streak }} days</h3>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="card-magical summary-card total">
            <i class="fas fa-capsules summary-icon text-secondary"></i>
            <h6 class="text-muted mb-1">Total Doses</h6>
            <h3 class="mb-0 text-secondary fw-bold">{{ total_doses }}</h3>
          </div>
        </div>
      </div>

      <!-- Today's Doses -->
      <div class="row mb-5">
        <div class="col-12">
          <div class="card-magical">
            <div class="card-header-magical">
              <h4 class="mb-0 text-white"><i class="fas fa-wand-sparkles me-2"></i>Today's Magical Schedule</h4>
            </div>
            <div class="card-body p-4">
              {% for dose in dose_data %}
              <div class="dose-item {{ dose.status }}">
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        {% if dose.status == 'taken' %}
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                        {% elif dose.status == 'missed' %}
                        <i class="fas fa-times-circle fa-2x text-danger"></i>
                        {% else %}
                        <i class="fas fa-clock fa-2x text-warning"></i>
                        {% endif %}
                      </div>
                      <div>
                        <h5 class="mb-1 text-dark fw-bold">{{ dose.pill_name }}</h5>
                        <p class="text-muted mb-0">
                          <i class="fas fa-hourglass-half me-1"></i>{{ dose.time }}
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <span class="badge badge-magical 
                      {% if dose.status == 'taken' %}text-success border-success
                      {% elif dose.status == 'missed' %}text-danger border-danger
                      {% else %}text-warning border-warning{% endif %}">
                      {% if dose.status == 'taken' %}‚úÖ Taken
                      {% elif dose.status == 'missed' %}‚ùå Missed
                      {% else %}‚è∞ Pending{% endif %}
                    </span>
                  </div>
                  <div class="col-md-2 text-end">
                    
                    <div class="btn-group">
                      <button class="btn btn-success btn-sm btn-magical mark-taken-btn" 
                              data-dose-id="{{ dose.dose_log_id }}">
                        <i class="fas fa-check me-1"></i>Taken
                      </button>
                      <button class="btn btn-danger btn-sm btn-magical mark-missed-btn" 
                              data-dose-id="{{ dose.dose_log_id }}">
                        <i class="fas fa-times me-1"></i>Missed
                      </button>
                    </div>
                   
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="empty-state">
                <i class="fas fa-star fa-4x text-warning mb-3"></i>
                <h4 class="text-muted">No spells to cast today!</h4>
                <p class="text-muted">Enjoy your magical day off! ‚ú®üéâ</p>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card-magical">
            <div class="card-header-magical">
              <h5 class="mb-0 text-white"><i class="fas fa-chart-pie me-2"></i>Today's Progress</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="todayChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card-magical">
            <div class="card-header-magical">
              <h5 class="mb-0 text-white"><i class="fas fa-chart-line me-2"></i>Weekly Magic</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="weeklyChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'components/chatbot.html' %}
  <script src="{% static 'medicines/js/chatbot.js' %}"></script>
  
  <script>
    // Status update functionality
    document.querySelectorAll('.mark-taken-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        updateDoseStatus(this.dataset.doseId, 'taken');
      });
    });

    document.querySelectorAll('.mark-missed-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        updateDoseStatus(this.dataset.doseId, 'missed');
      });
    });

    function updateDoseStatus(doseId, status) {
      fetch("{% url 'toggle_dose_status' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          dose_log_id: doseId,
          status: status
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            location.reload();
          } else {
            alert('Magic failed: ' + (data.message || 'Failed to update'));
          }
        });
    }

    // Initialize charts
    document.addEventListener('DOMContentLoaded', function () {
      const doseData = JSON.parse('{{ dose_data_json|escapejs }}');
      const weeklyAdherence = JSON.parse('{{ weekly_adherence_json|escapejs }}');
      const weekDays = JSON.parse('{{ week_days_json|escapejs }}');

      // Today's Progress Chart
      const todayCtx = document.getElementById('todayChart');
      if (todayCtx) {
        const takenCount = doseData.filter(d => d.status === 'taken').length;
        const missedCount = doseData.filter(d => d.status === 'missed').length;
        const pendingCount = doseData.filter(d => d.status === 'pending').length;

        new Chart(todayCtx, {
          type: 'doughnut',
          data: {
            labels: ['Taken', 'Missed', 'Pending'],
            datasets: [{
              data: [takenCount, missedCount, pendingCount],
              backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
              borderWidth: 3,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  font: {
                    family: 'Quicksand',
                    weight: '600'
                  }
                }
              }
            }
          }
        });
      }

      // Weekly Adherence Chart
      const weeklyCtx = document.getElementById('weeklyChart');
      if (weeklyCtx) {
        new Chart(weeklyCtx, {
          type: 'line',
          data: {
            labels: weekDays,
            datasets: [{
              label: 'Adherence %',
              data: weeklyAdherence,
              borderColor: '#1a3e6f',
              backgroundColor: 'rgba(26, 62, 111, 0.1)',
              borderWidth: 3,
              pointBackgroundColor: '#1a3e6f',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function (value) {
                    return value + '%';
                  },
                  font: {
                    family: 'Quicksand'
                  }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              },
              x: {
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                  font: {
                    family: 'Quicksand'
                  }
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  font: {
                    family: 'Quicksand',
                    weight: '600'
                  }
                }
              }
            }
          }
        });
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>